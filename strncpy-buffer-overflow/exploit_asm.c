/*
 * This is an assembly program to execute the updatedb program.
 * Last modified: April 04th 2020
 * Author: Boladji Vinny - https://vinny.coach / @boladjivinny / https://gitlab.com/boladji
 * Licence: Free GPL
 *
*/ 

// Compile with gcc -ggdb -Wl,--omagic -o exploit_asm exploit_asm.c -static \ 
// -fno-stack-protector -mpreferred-stack-boundary=3
//


int main()
{
	__asm__(
			"jmp 		jmptgt		\n\t"
			"aftjmp:	pop %rbx	\n\t"
			"xor 		%rdx, %rdx	\n\t" // Get a 0 stored in rdx
			"push		%rdx		\n\t" // Push the value of rdx on the stack -> NULL
			"mov 		%dl, 0x11(%rbx)	\n\t" // Replace the x in the executable path by \0
			"push		%rbx		\n\t" // Push the updated program path on the stack
			"mov		%rsp, %rsi	\n\t" // Copy the top of the stack into rsi (second argument). We have then an a string followed by NULL as expected by execve
			"push		%rbx		\n\t" // Push the string on the stack and pop into %rdi (first argument)
			"pop		%rdi		\n\t"
			"pushq 		$0x3b		\n\t"
			"pop		%rax		\n\t" // Store 13 system code and call syscall (run execve)
			"syscall			\n\t"
			"jmptgt:	call aftjmp	\n\t"
			".string \"/usr/bin/updatedbx\""
			         //0123456789abcdef01
	       );
}
